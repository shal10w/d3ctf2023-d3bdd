# d3bdd

## Background

There are two main attack methods for LWE: primal attack and dual attack. In theory, the complexity of these two attacks is similar. But the implementation of primal attack is quite simple, and the actual complexity is lower than dual attack. So in CTF, we always use primal attack, not the dual attack. But resently, the theoretical complexity of dual attack with FFT distinguisher^[1,2]^ is slightly lower than primal attack.(but there are still some problems in their work^[3]^), so I want to introduce dual attack to you with this CTF challenge.

One difference between dual attack and primal attack is that dual attack reduces the LWE problem into an aSVP problem, not the uSVP problem. And if a lattice have special properties, its left kernel has an easy-to-find and very short vector, then the complexity of the dual attack will be much smaller than that of the primal attack, which is the main idea of this challenge.

The challenge is mainly divided into two parts, the PRNG and the BDD problem on an ideal lattice. My expectation is that the polynomial generated by using an inappropriate PRNG has an very short vector that is easy to find , and then use dual attack to solve the BDD problem.

## Unexpected Solution

None of the teams that solved the problem in the competition solved the problem in the expected way.

This is due to the use of $x^{512} - 1$ when selecting the modulus polynomial of the polynomial ring. This polynomial has many small factors, especially $x^{128}+1$ and $x^{ 128}-1$, the RLWE problem mod these two factors only needs to reduce the 256-dimensional lattice, and because the noise is very small, the result can be solved. From this, the value of $s \% (x^{256}-1)$ can be obtained through the CRT algorithm. Although the value of $s\%(x^{256}+1)$ cannot be obtained (the dimension of the lattice reaches 512), but because the value of $s$ is a flag, it is a printable and meaningful string, so Players can judge the correctness of the flag by guessing the words and checking the hash.

The reason for the unexpected occurrence is mainly because of the selection of the modular polynomial. I should select $x^{512}+1$ as the modular polynomial. 

The expected solution can solve both cases.

## Expected Solution

### Dual Attack

Let's introduce the process of dual attack first.

Dual attack can judge whether a pair (A,b) is a LWE instance. If it conforms, then
$$
As + e = b \mod{q}
$$
Now we find two short vectors $u, v$ satisfy
$$
uA = v \mod{q}
$$
Multiply both sides of (1) by $u$.We can get
$$
vs + ue = ub\mod{q}
$$
Since $s$ and $e$ are small, $vs$ and $ue$ are also small, so $ub$ is small too.

But if this pair (A,b) is not an instance of LWE, then $ub$ should be uniformly distributed, expected to be around $q/2$, through which we can solve the decision-LWE problem.

How to use such an attack to obtain $s$?

We can enumerate a part of s, for example, let s = (s1 | s2), and enumerate the value of s1
$$
As + e = A_1s_1 + A_2s_2+e = b\\
A_2s_2 + e = b- A_1s_1 = b'
$$
If the guessed s1 is correct, $(A_2 , b')$ is an LWE instance, but not vice versa, so we can find the complete $s$ by enumerating.

### Ideal Lattice

How to find such $u$? First of all, we need to observe the shape of Lattice A. If the modulo polynomial is $x^{512} +1$, the lattice is like this:
$$
\left(
    \begin{matrix}
    	a_0 & -a_{n-1} & -a_{n-2} & \cdots & -a_1\\
    	a_1 & a_{0} & -a_{n-1} & \cdots & -a_2 \\
    	\vdots & \vdots& \vdots & \ddots & \vdots\\
    	a_{n-1} & a_{n-2} & a_{n-3} & \cdots & a_0
    \end{matrix}
\right)
$$
If the modulo polynomial is $x^{512}-1$ . Like this:
$$
\left(
    \begin{matrix}
    	a_0 & a_{n-1} & a_{n-2} & \cdots & a_1\\
    	a_1 & a_{0} & a_{n-1} & \cdots & a_2 \\
    	\vdots & \vdots& \vdots & \ddots & \vdots\\
    	a_{n-1} & a_{n-2} & a_{n-3} & \cdots & a_0
    \end{matrix}
\right)
$$
They are similar. And both have a very important feature that each of its columns is circular, and we can find many of the same patterns.

For example,the pattern like $a_{n-1}, a_{n}$, in the first two rows, only $a_{n-1}, a_0$ in the second column near the diagonal line do not match, the others conform to this pattern.

That is, if I find a vector $u = (u_1 , u_2)$ that for any n, it satisfies
$$
u_1a_{n-1} + u_2a_{n} = 0
$$
Then if it multiplies the first two rows of A, almost every dimension of the result will be 0, and only one dimension is not 0. Therefore, our goal is to find $u$ that satisfies the formula like (7), and then we can use dual attack to solve the challenge.

### PRNG

We can find that this PRNG is a linear generator modulo m
$$
a_{n+17}=\sum_{i=0}^{16}a_{n+i}f_i\mod{m}
$$
Let $f_{17} = -1$. Then
$$
\sum_{i=0}^{17}a_{n+i}f_i = 0 \mod{m}
$$
This f multiplied by the first 17 rows of A has been able to make most of the dimensions of the result 0, but since the f in the challenge is randomly selected, the value is very large. We need a smaller f.

To solve this, we can take a few more n and sum the formula (9), that is
$$
\sum_{j=0}^k(c_j\sum_{i=0}^{17}a_{j+i}f_i) = 0 \mod{m}\\
\sum_{i=0}^{k+17}a_i(\sum_{j=max(0,i-k)}^{min(17,i)}f_jc_{i-j}) = \sum_{i=0}^{k+17}a_if_i' \mod{m}
$$
$c_i$ is optional, so we can construct the following Lattice to find a small $f'$
$$
\left(
    \begin{matrix}
    	mI\\
  		F
    \end{matrix}
\right)
$$

$$
F = \left(
    \begin{matrix}
    	f_0 & f_{1} & \cdots & f_{17}\\
    	    & f_{0} & f_{1} & \cdots & f_{17} \\
    	& & \ddots &  & \\
    	& & & f_0 & f_1&\cdots&f_{17}
    \end{matrix}
\right)
$$

Under the parameter conditions of this challenge, taking k to about 80 can have relatively good results. But it also means that we need to enumerate 80bit $s$, which is not acceptable. However, the s in the challenge is not a random value. It has a length of 9 bytes (72-bit) flag header `antd3ctf{` (coincidentally, the flag header is really long), so we needn't to enumerate too much.

### m is not q?

Here, we encounter another important problem. The above calculation is established under modulus m, while the modulus of LWE is q, and m%q is also quite large. If this problem is not solved, the vector obtained above is unusable.

Try to remove the mod m in the above formula. We can get
$$
f'A = gm
$$
$g$ is a vector, and since A is smaller than m, g will only be slightly larger than f', at most k times of f' (k is the dimension of f'), but it is almost impossible to be so large in practice.

Additionally, in the last year([leak_dsa]([D3CTF-2022-crypto-d3share_leakdsa/wp_en.md at main · shal10w/D3CTF-2022-crypto-d3share_leakdsa · GitHub](https://github.com/shal10w/D3CTF-2022-crypto-d3share_leakdsa/blob/main/writeup/wp_en.md)), a crypto challenge of d3ctf2022), we used a trick that can balance an item by multiplying it by a magic value.

Construct a lattice like this:
$$
\left(
    \begin{matrix}
		q & 0\\
		m & 1
    \end{matrix}
\right)
$$
After reduction, we can get a short vector $(q1,q2)$ satisfies
$$
q_2m = q_1 \mod{q}
$$
Theoretically, the q_1 and q_2 obtained in this way will be around $\sqrt{q}$, but the m I have chosen in this challenge is a bit special. Its q_1 = 5049, q_2 = -6683. They are much smaller than the expected result, so the success rate in the dual attack will be higher, but if the size of the obtained result is around $\sqrt{q}$, it is still theoretically possible to solve with dual attack, but It may be necessary to obtain more vectors, higher dimensions or use more techniques such as sieving or FFT distinguisher and so on.

Let's come back to the original formula.
$$
A_2s_2 + e = b'\mod{q}\\
f'A_2s_2 + f'e = mgs_2 + f'e = f'b'\mod{q}\\
q_1gs_2 + q_2f'e = q_2f'b'\mod{q}
$$
Finally, in the experiment, if you guessed $s_1$ correctly, the value of $q_2f'b'$ on the right side of the equation is about q/100, which is about 1/50 of the expected value of choosing uniformly. So the flag can be computed by a very high probability.

Since the success rate is not 100%, I additionally gave the hash of the flag to provide convenience for players to check whether the flag is correct.

### Reference

[1] Q. Guo and T. Johansson, ‘Faster Dual Lattice Attacks for Solving LWE with Applications to CRYSTALS’, in *Advances in Cryptology – ASIACRYPT 2021*, M. Tibouchi and H. Wang, Eds., in Lecture Notes in Computer Science, vol. 13093. Cham: Springer International Publishing, 2021, pp. 33–62. doi: [10.1007/978-3-030-92068-5_2](https://doi.org/10.1007/978-3-030-92068-5_2).

[2] MATZOV. (2022). “Report on the Security of LWE: Improved Dual Lattice Attack”. Zenodo. https://doi.org/10.5281/zenodo.6412487

[3] L. Ducas and L. N. Pulles, ‘Does the Dual-Sieve Attack on Learning with Errors even Work?’. https://eprint.iacr.org/2023/302